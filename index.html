<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>灯（トモリ）と乾杯♪</title>
  <style>
    body{margin:0;background:#0f0f12;color:#eee;font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    header{padding:20px 16px;border-bottom:1px solid #222;display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;padding:4px 8px;border:1px solid #444;border-radius:999px;color:#bbb}
    #log{max-width:900px;margin:24px auto;padding:0 16px;min-height:55vh}
    .msg{max-width:720px;margin:10px 0;padding:12px 14px;border-radius:12px;line-height:1.7;white-space:pre-wrap}
    .me{background:#1f2937;margin-left:auto}
    .bot{background:#131722;border:1px solid #1e2230}
    form{position:sticky;bottom:0;background:#0f0f12;padding:12px 16px;border-top:1px solid #222;display:flex;gap:8px}
    textarea{flex:1;min-height:52px;max-height:160px;resize:vertical;background:#0c0c10;color:#eee;border:1px solid #333;border-radius:10px;padding:12px;line-height:1.6}
    button{background:#3b82f6;border:none;color:#fff;padding:0 16px;border-radius:10px;font-weight:600}
    .hint{color:#9aa4b2;font-size:13px;margin:4px 0 0 16px}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:22px;">灯（トモリ）と乾杯♪</h1>
    <span id="badge" class="pill">ご案内中</span>
  </header>

  <div id="log"></div>
  <div class="hint">例：一杯飲みながら話していいですか？</div>

  <form id="f">
    <textarea id="t" placeholder="メッセージを入力…"></textarea>
    <button id="send">送信</button>
  </form>

  <script>
    const log = document.getElementById('log');
    const t   = document.getElementById('t');
    const f   = document.getElementById('f');
    const badge = document.getElementById('badge');

    let stage = 'age';              // サーバの状態機械と同期
    const conversation_id = crypto.randomUUID();

    addBot("接続しています…");
    // ヘルスチェック（GET）
    fetch('/api/tomori').then(() => {
      log.lastChild.remove();
      addBot("いらっしゃいませ。お酒は20歳以上のお客様のみご案内できます。お客様は20歳以上でいらっしゃいますか？");
    }).catch(() => {
      log.lastChild.textContent = "（接続エラーです）";
    });

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = t.value.trim();
      if (!text) return;
      addMe(text);
      t.value = '';
      const reply = await callApi(text);
      addBot(reply.reply);
      stage = reply.nextStage || stage;
      badge.textContent = stage === 'main' ? '会話中' : 'ご案内中';
    });

    function addMe(s){ add(s,'me'); }
    function addBot(s){ add(s,'bot'); }
    function add(s,cls){
      const div = document.createElement('div');
      div.className = `msg ${cls}`;
      div.textContent = s;
      log.appendChild(div);
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    }

    async function callApi(user_text){
      const r = await fetch('/api/tomori', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ conversation_id, user_text, user_name: 'お客様', stage })
      });
      if (!r.ok) return { reply: 'ただいま混み合っています。少し置いてお試しください。', nextStage: stage };
      return await r.json();
    }
  </script>
</body>
</html>
