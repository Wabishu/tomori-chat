<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>灯（トモリ）と乾杯♪</title>
<link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="top">
    <h1>灯（トモリ）と乾杯♪</h1>
    <div class="note">例：今日はどんな一日でした？ / ちょっと雑談してもいい？</div>
  </header>

  <main>
    <div id="chat" class="chat"></div>
    <div class="inputRow">
      <textarea id="ta" rows="2" placeholder="メッセージを入力…" autocomplete="off"></textarea>
      <button id="send">送信</button>
    </div>
  </main>

<script>
const API = "/api/tomori";
const chat = document.getElementById("chat");
const ta = document.getElementById("ta");
const sendBtn = document.getElementById("send");

// 色
const COLORS = { "灯":"#FF9C66", "瞳":"#8BC34A", "響":"#42A5F5", "縁":"#C586C0" };
// 速度（サーバーから来たら上書き）
let typingSpeed = { "灯":14, "瞳":14, "響":20, "縁":26 };

// 会話ターンインデックス（ローテーション用）
let turnIndex = 0;

function addUserBubble(text){
  const wrap = document.createElement("div");
  wrap.className = "bubble user";
  const body = document.createElement("div");
  body.className = "text";
  body.textContent = text;
  wrap.appendChild(body);
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

async function typeOut(el, text, cps=18){
  el.textContent = "";
  for (const ch of text){
    el.textContent += ch;
    await new Promise(r=>setTimeout(r, 1000/Math.max(8,cps)));
  }
}

async function addBotBubble(speaker, text){
  const wrap = document.createElement("div");
  wrap.className = "bubble bot";
  wrap.style.borderLeft = `4px solid ${COLORS[speaker]||"#ccc"}`;

  const who = document.createElement("div");
  who.className = "who";
  who.style.color = COLORS[speaker]||"#999";
  who.textContent = `【${speaker}】`;

  const body = document.createElement("div");
  body.className = "text";

  wrap.appendChild(who);
  wrap.appendChild(body);
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;

  const cps = typingSpeed[speaker] ?? 18;
  await typeOut(body, text, cps);
  chat.scrollTop = chat.scrollHeight;
}

async function renderReply(payload){
  if (payload.typing){
    typingSpeed = {
      "灯": payload.typing.Tomori ?? typingSpeed["灯"],
      "瞳": payload.typing.Hitomi ?? typingSpeed["瞳"],
      "響": payload.typing.Hibiki ?? typingSpeed["響"],
      "縁": payload.typing.Enishi ?? typingSpeed["縁"]
    };
  }
  await addBotBubble(payload.mainSpeaker||"灯", payload.reply);
  if (payload.side){
    await addBotBubble(payload.side.speaker, payload.side.line);
  }
}

async function send(){
  const text = ta.value.trim();
  if (!text) return;
  addUserBubble(text);
  ta.value = "";

  const r = await fetch(API, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-turn-index": String(turnIndex)
    },
    body: JSON.stringify({
      user_text: text,
      user_name: "お客様"
    })
  }).catch(()=>null);

  if (!r || !r.ok){
    await addBotBubble("灯","（接続が不安定です。少し置いてお試しください）");
    return;
  }
  const data = await r.json();
  await renderReply(data);

  // 次ターンへ
  turnIndex = (turnIndex + 1) % 4;
}

sendBtn.addEventListener("click", send);
ta.addEventListener("keydown", (e)=>{
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});
</script>
</body>
</html>

