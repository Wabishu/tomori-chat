<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>灯（トモリ）と乾杯♪</title>
  <style>
    :root { --bg:#111; --panel:#1b1b1b; --text:#eee; --muted:#aaa; --acc:#e5bf5b; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"ヒラギノ角ゴ ProN","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-weight:700;margin:0 0 8px}
    .hint{color:var(--muted);margin:0 0 16px}
    .chat{height:60vh;min-height:420px;background:var(--panel);border-radius:16px;padding:16px;overflow:auto;box-shadow:0 0 0 1px #222 inset}
    .row{display:flex;gap:12px;margin:12px 0}
    .me{justify-content:flex-end}
    .bot .bubble{background:#242424;border:1px solid #2b2b2b}
    .me  .bubble{background:#2b2b2b;border:1px solid #3a3a3a}
    .bubble{max-width:72%;padding:12px 14px;border-radius:14px;line-height:1.6;white-space:pre-wrap}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    form{display:flex;gap:10px;margin-top:14px}
    textarea{flex:1;background:#191919;color:var(--text);border:1px solid #2a2a2a;border-radius:12px;padding:12px;resize:none;min-height:48px;line-height:1.6}
    button{background:var(--acc);color:#231a00;border:0;border-radius:12px;padding:0 18px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .sys{font-size:12px;color:#bbb;margin-top:8px}
    .badge{background:#2a2a2a;border:1px solid #3a3a3a;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>灯（トモリ）と乾杯♪ <span id="stageBadge" class="badge"></span></h1>
    <p class="hint">例：一杯飲みながら話していいですか？</p>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="form">
      <textarea id="input" placeholder="メッセージを入力…" rows="2"></textarea>
      <button id="send" type="submit">送信</button>
    </form>

    <p class="sys">※ 滞在時間の目安は30分です。初回は年齢とご利用条件を確認します。</p>
  </div>

  <script>
    // --------- 会話段階（年齢→反社→本編→終了） ----------
    let stage = localStorage.getItem('tomori_stage') || 'age'; // 'age'|'crime'|'main'|'end'
    let pending = false;

    const chat   = document.getElementById('chat');
    const form   = document.getElementById('form');
    const input  = document.getElementById('input');
    const sendBtn= document.getElementById('send');
    const badge  = document.getElementById('stageBadge');

    const stageLabel = s => ({age:'年齢確認',crime:'ご利用条件',main:'ご案内中',end:'終了'})[s] || s;
    const updateBadge = () => badge.textContent = stageLabel(stage);
    updateBadge();

    const scrollBottom = () => chat.scrollTop = chat.scrollHeight;

    function row(role, text){
      const r = document.createElement('div');
      r.className = 'row ' + (role === 'user' ? 'me' : 'bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      r.appendChild(b);
      chat.appendChild(r);
      scrollBottom();
    }

    // 初回挨拶（年齢確認をAPI側でも出すが、空白だと不安なので表示のみ）
    if (!localStorage.getItem('tomori_boot')) {
      row('assistant','いらっしゃいませ。お酒は20歳以上のお客様のみご案内できます。お客様は20歳以上でいらっしゃいますか？');
      localStorage.setItem('tomori_boot','1');
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (pending) return;
      const text = input.value.trim();
      if (!text) return;

      pending = true; sendBtn.disabled = true;
      row('user', text);

      try{
        const r = await fetch('/api/tomori', {
          method:'POST',
          headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          cache:'no-store',
          body: JSON.stringify({ user_name:'お客様', user_text:text, stage })
        });
        const data = await r.json().catch(()=>({reply:'（接続エラーです）'}));
        if (data.reply) row('assistant', data.reply);
        if (data.nextStage) {
          stage = data.nextStage;
          localStorage.setItem('tomori_stage', stage);
          updateBadge();
        }
      } catch(err){
        row('assistant','（接続が不安定です。少し置いてお試しください）');
      } finally{
        input.value = '';
        pending = false; sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
