<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>灯（トモリ）と乾杯♪</title>
<style>
  :root{
    --bg:#121212; --panel:#1e1e1e; --line:#2b2b2b; --fg:#e9e9e9;
    --user:#3a3a3a;
    --tomori:#ff6666; /* 灯 */
    --hibiki:#66a3ff; /* 響 */
    --hitomi:#ffcc66; /* 瞳 */
    --en:#99cc99;     /* 縁 */
  }
  html,body{height:100%; background:var(--bg); color:var(--fg); margin:0; font-family:ui-sans-serif,system-ui,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
  .wrap{max-width:960px; margin:0 auto; padding:20px; box-sizing:border-box;}
  h1{font-size:22px; margin:0 0 10px; font-weight:700}
  .note{opacity:.7; font-size:12px; margin-bottom:14px}
  .chat{border:1px solid var(--line); background:var(--panel); border-radius:12px; height:60vh; overflow:auto; padding:12px}
  .message{padding:10px 12px; border-radius:8px; margin:8px 0; line-height:1.6; word-break:break-word; white-space:pre-wrap}
  .user{background:var(--user); color:#fff}
  .tomori{background:var(--tomori); color:#fff}
  .hibiki{background:var(--hibiki); color:#fff}
  .hitomi{background:var(--hitomi); color:#000}
  .en{background:var(--en); color:#000}
  .row{display:flex; gap:8px; margin-top:10px}
  textarea{flex:1; resize:none; min-height:56px; border:1px solid var(--line); border-radius:8px; padding:10px; background:#151515; color:var(--fg); outline:none}
  button{padding:10px 16px; border:0; border-radius:8px; background:#2b6fff; color:#fff; font-weight:700; cursor:pointer}
  button:disabled{opacity:.6; cursor:not-allowed}
  .sys{opacity:.7; font-size:12px; text-align:center; margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>灯（トモリ）と乾杯♪</h1>
  <div class="note">※ 改行せずに送る：Enter（改行は Shift+Enter）</div>

  <div id="chat" class="chat"></div>

  <div class="row">
    <textarea id="ta" placeholder="例：今日はどんな一日でした？ / ちょっと雑談してもいい？"></textarea>
    <button id="send">送信</button>
  </div>
  <div class="sys" id="sys"></div>
</div>

<script>
const chat = document.getElementById('chat');
const ta   = document.getElementById('ta');
const btn  = document.getElementById('send');
const sys  = document.getElementById('sys');

function bubble(text, cls){
  const el = document.createElement('div');
  el.className = 'message ' + cls;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
  return el;
}

function clsFromTag(reply){
  const m = reply.match(/^【(.+?)】/);
  if(!m) return 'tomori';
  const t = m[1];
  if(t.includes('灯')) return 'tomori';
  if(t.includes('響')) return 'hibiki';
  if(t.includes('瞳')) return 'hitomi';
  if(t.includes('縁')) return 'en';
  return 'tomori';
}
function stripTag(s){ return s.replace(/^【.+?】\s*/,''); }

async function send(){
  const text = ta.value.trim();
  if(!text) return;

  bubble(text,'user');
  ta.value = '';
  btn.disabled = true; sys.textContent = '…送信中';

  try{
    const r = await fetch('/api/tomori.js', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user_text:text })
    });
    if(!r.ok){
      bubble('（接続が不安定です。少し置いてお試しください）','tomori');
      return;
    }
    const { reply } = await r.json();
    const cls = clsFromTag(reply);
    const body = stripTag(reply);
    bubble(body, cls);
  }catch(e){
    bubble('（通信エラーです）','tomori');
  }finally{
    btn.disabled = false; sys.textContent = '';
    ta.focus();
  }
}

btn.addEventListener('click', send);
ta.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault(); send();
  }
});

// 初回の軽い挨拶（APIは呼ばない）
bubble('いらっしゃいませ。どうぞごゆっくり。雑談からでも大歓迎です。','tomori');
</script>
</body>
</html>

